"""
–ú–æ–¥—É–ª—å —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

–°–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —á–∞—Å—Ç–µ–π UI:
- render_sidebar: –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–æ–≤
- render_messages: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
- load_chat: –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ –∏–∑ –ë–î

–í—ã–Ω–µ—Å–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫.
"""

import streamlit as st
from database import get_chats, get_messages


def load_chat(chat_id: int):
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —á–∞—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏.
    
    Args:
        chat_id: ID —á–∞—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    
    Side Effects:
        - –û–±–Ω–æ–≤–ª—è–µ—Ç st.session_state.chat_id
        - –û–±–Ω–æ–≤–ª—è–µ—Ç st.session_state.messages
        - –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∞
        - –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (st.rerun)
    """
    st.session_state.chat_id = chat_id
    st.session_state.messages = get_messages(chat_id)
    st.session_state.current_graph_state = None
    st.session_state.awaiting_user_response = False
    st.rerun()


def render_sidebar():
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —á–∞—Ç–∞–º–∏.
    
    –°–æ–¥–µ—Ä–∂–∏—Ç:
    - –ö–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞
    - –ó–∞–≥—Ä—É–∑—á–∏–∫ —Ñ–∞–π–ª–æ–≤ (.txt, .md)
    - –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
    
    Returns:
        str: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    """
    with st.sidebar:
        st.title("Consilium")
        st.divider()
        
        # –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞
        if st.button("‚ûï –ù–æ–≤—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç"):
            st.session_state.messages = []
            st.rerun()

        # –ó–∞–≥—Ä—É–∑—á–∏–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        uploaded_file = st.file_uploader(
            "–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª (.txt, .md)",
            type=['txt', 'md']
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≥—Ä–∞—Ñ–µ
        file_content_on_start = ""
        if uploaded_file:
            file_content_on_start = uploaded_file.read().decode("utf-8")
            st.info("–§–∞–π–ª –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ.")

        st.divider()
        
        # –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤
        st.subheader("–ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤")
        chats = get_chats()
        if not chats:
            st.caption("–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞.")
        else:
            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞–∂–¥—ã–π —á–∞—Ç –∫–∞–∫ –∫–Ω–æ–ø–∫—É
            for chat in chats:
                if st.button(
                    f"{chat['title']}",
                    key=f"chat_{chat['id']}",
                    use_container_width=True
                ):
                    load_chat(chat['id'])
    
    return file_content_on_start


def render_messages():
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞.
    
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–∏—Å—Ç–µ–º—ã –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
    —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∞–≤–∞—Ç–∞—Ä–∞–º–∏.
    """
    for msg in st.session_state.messages:
        # –í—ã–±–∏—Ä–∞–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–≤—Ç–æ—Ä–∞
        avatar = "üë§" if msg['author'] == 'user' else "ü§ñ"
        
        with st.chat_message(msg['author'], avatar=avatar):
            st.markdown(msg['content'])

